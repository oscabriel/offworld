## 2026-01-10: PRD-001, PRD-002 - Remove tree-sitter, add heuristics

### Completed
- PRD-001: Removed tree-sitter dependency
- PRD-002: Implemented heuristics-based file scoring

### Changes
- Deleted `/packages/sdk/src/importance/` (parser.ts, queries.ts, ranker.ts, index.ts)
- Deleted `/packages/sdk/src/__tests__/importance.test.ts`
- Created `/packages/sdk/src/analysis/heuristics.ts` - path-based scoring:
  - Entry points: 0.9, Config: 0.8, Types: 0.75, Source: 0.6-0.7, Tests: 0.3
- Updated `context.ts`, `pipeline.ts` to use `rankFilesByHeuristics`
- Updated `index.ts` to export heuristics instead of tree-sitter
- Removed `web-tree-sitter` from package.json
- Fixed tests: analysis.test.ts, pipeline.test.ts, pipeline-io.test.ts

### Decisions
- Scoring uses pure path heuristics, no parsing
- Default limits: maxFiles=500, maxFileSize=100KB (down from 10000/1MB)
- Tests mock `rankFilesByHeuristics` and `generateRichSkill`

### Verification
- TypeScript: passes
- Tests: 391 passed
- Lint: 0 errors

---

## 2026-01-10: PRD-003 - Combine summary+architecture into single AI call

### Completed
- PRD-003: Combined AI calls (3→2)

### Changes
- Added `SUMMARY_ARCHITECTURE_TEMPLATE` to prompts.ts with "=== SECTION ===" delimiters
- Added `generateSummaryAndArchitecture()` to generate.ts
- Added `parseSummaryAndArchitecture()` parser using delimiter extraction
- Updated pipeline.ts: replaced separate calls with combined `analyze` step
- Updated tests: mocks, progress step assertions

### Decisions
- Delimiter format: `=== SUMMARY ===` and `=== ARCHITECTURE ===`
- Fallback: split at midpoint if delimiters missing
- Progress step renamed from "summary"/"architecture" to "analyze"

### Verification
- TypeScript: passes
- Tests: 391 passed
- Lint: 0 errors

---

## 2026-01-10: PRD-004 - Optional architecture generation

### Completed
- PRD-004: Added `--skip-architecture` flag for faster summary-only mode

### Changes
- `packages/sdk/src/analysis/pipeline.ts`:
  - Added `includeArchitecture?: boolean` option (default: true)
  - Architecture fields now nullable in `AnalysisPipelineResult`
  - Conditional save: skip architecture.json/md when null
  - Uses `generateSummary()` when architecture skipped
- `packages/sdk/src/analysis/generate.ts`:
  - `generateRichSkill()` accepts `Architecture | null`
- `packages/sdk/src/analysis/prompts.ts`:
  - `createSkillPrompt()` handles null architectureJson
- `apps/cli/src/handlers/generate.ts`, `pull.ts`:
  - Added `skipArchitecture` option
- `apps/cli/src/index.ts`:
  - Added `--skip-architecture` flag to `generate` and `pull` commands

### Decisions
- Default is `includeArchitecture: true` for backward compat
- Skill generation still works without architecture (just excludes arch section)

### Verification
- TypeScript: SDK/CLI pass (web has pre-existing errors)
- Tests: 391 passed
- Lint: 0 errors

---

## 2026-01-10: PRD-006/007/008 - Update skill frontmatter

### Completed
- PRD-006: Remove allowed-tools from frontmatter
- PRD-007: Add commit SHA (7-char) to frontmatter
- PRD-008: Add generated date (YYYY-MM-DD) to frontmatter

### Changes
- `packages/sdk/src/analysis/generate.ts`:
  - `FormatSkillOptions` interface with commitSha/generated
  - `formatSkillMd()` now accepts options, outputs commit/generated fields
  - `injectSkillMetadata()` post-processes AI output to add fields
  - `SkillGenerateOptions` extended with commitSha/generated
- `packages/sdk/src/analysis/prompts.ts`:
  - Removed `allowed-tools: [Read, Grep, Glob, Task]` from template
- `packages/sdk/src/analysis/pipeline.ts`:
  - Passes commitSha and generated date to skill generation
- `apps/cli/src/handlers/pull.ts`:
  - Updated `formatSkillMd()` with same signature
  - Added `loadLocalMeta()` helper
  - All formatSkillMd calls now pass metadata

### Tests updated
- skill.test.ts: Tests for commit/generated, no allowed-tools
- generate.test.ts: Updated formatSkillMd assertions

### Verification
- TypeScript: SDK/CLI pass
- Tests: 392 passed (+1)
- Lint: 0 errors

---

## 2026-01-10: PRD-009 - Deep Context section in skills

### Completed
- PRD-009: Add Deep Context section referencing analysis files

### Changes
- `packages/sdk/src/analysis/prompts.ts`:
  - Added `analysisPath` parameter to `createSkillPrompt()`
  - Added `deepContextSection` template with paths to architecture.md/summary.md
- `packages/sdk/src/analysis/generate.ts`:
  - Added `analysisPath` to `SkillGenerateOptions`
  - Passed to `createSkillPrompt()`
- `packages/sdk/src/analysis/pipeline.ts`:
  - Passes `analysisPath` to skill generation

### Verification
- TypeScript: SDK pass
- Tests: 392 passed
- Lint: 0 errors

---

## 2026-01-10: PRD-014 - Shallow clones by default

### Completed
- PRD-014: Default shallow clones with --full-history option

### Changes
- `apps/cli/src/index.ts`:
  - Added `negativeAlias: "full-history"` to shallow flag
  - Users can use `--full-history` (or `--no-shallow`) for full clone

### Notes
- Shallow was already default (true)
- Just needed explicit --full-history alias per PRD

### Verification
- TypeScript: pass
- Tests: 392 passed
- Lint: 0 errors

---

## 2026-01-10: PRD-010 - Validate file paths in skills

### Completed
- PRD-010: Validate paths exist before writing to skill

### Changes
- Created `packages/sdk/src/validation/paths.ts`:
  - `validateSkillPaths()` filters invalid paths from skill
  - `pathExists()` helper for individual path checks
- Created `packages/sdk/src/validation/index.ts`: exports
- Updated `packages/sdk/src/analysis/pipeline.ts`:
  - Imports validateSkillPaths
  - Calls validation after skill generation
  - Re-formats skillMd if paths were removed
  - Uses onDebug for warning about removed paths
- Updated `packages/sdk/src/index.ts`: exports validation module
- Added `packages/sdk/src/__tests__/validation.test.ts`: unit tests
- Updated pipeline.test.ts: added existsSync/formatSkillMd mocks
- Updated pipeline-io.test.ts: mocked validation for real fs tests

### Decisions
- Validation happens post-generation, before save
- Only repositoryStructure and keyFiles paths are validated
- Paths starting with ~ are not resolved (assumed home-relative)

### Verification
- TypeScript: SDK/CLI pass
- Tests: 398 passed (+6 new)
- Lint: 0 errors

---

## 2026-01-10: PRD-005 - Reduce skill output to ~100 lines

### Completed
- PRD-005: Slim skill format (~100 lines vs 250-400)

### Changes
- `packages/sdk/src/analysis/prompts.ts`:
  - Rewrote `createSkillPrompt()` for slim output
  - Target: 80-120 lines, no prose
  - Format: Quick Paths (15-20 files), Search Patterns table, Deep Context section
  - Removed: verbose sections (Best Practices, When to Use, Key Concepts, etc.)
  - Removed: file content samples (topFiles with content)
- `packages/sdk/src/analysis/generate.ts`:
  - Updated system prompt for slim skill generation

### Decisions
- Skills now focus on: paths, patterns, and references
- No prose sections - agents can read Deep Context files for details
- Search Patterns as markdown table (4-6 rows)
- File content removed from prompt to reduce token usage

### Verification
- TypeScript: SDK pass
- Tests: 392 unit tests pass (integration tests have pre-existing issues)
- Lint: 0 errors

---

## 2026-01-10: PRD-011 - Staleness detection for cached analyses

### Completed
- PRD-011: isAnalysisStale() function comparing commit SHAs

### Changes
- Created `packages/sdk/src/validation/staleness.ts`:
  - `isAnalysisStale(analysisPath, currentSha)` returns `StalenessCheckResult`
  - `getCachedCommitSha(analysisPath)` helper
  - Compares first 7 chars of SHA for match
  - Returns reason: "missing_meta" | "sha_mismatch" | "parse_error"
- Updated `packages/sdk/src/validation/index.ts`: exports staleness functions
- Updated `packages/sdk/src/index.ts`: exports to public API
- Refactored `apps/cli/src/handlers/pull.ts`:
  - `hasLocalAnalysis()` now uses SDK's `isAnalysisStale()`
  - Removed duplicate meta.json parsing logic
- Added tests in `packages/sdk/src/__tests__/validation.test.ts`: 8 new tests
- Updated `apps/cli/src/__tests__/handlers.test.ts`: mock isAnalysisStale

### Decisions
- Normalized SHA comparison (7-char prefix) for flexibility
- Staleness result includes reason for debugging
- CLI delegates staleness logic to SDK (single source of truth)

### Verification
- TypeScript: SDK/CLI pass
- Tests: 406 + 22 = 428 passed
- Lint: 0 errors

---

## 2026-01-10: PRD-016 - Reduce context gathering limits

### Completed
- PRD-016: Performance optimization via reduced context limits

### Changes
- Created `CONTEXT_LIMITS` in `packages/sdk/src/constants.ts`:
  - `MAX_CONTEXT_TOKENS`: 4000 → 3000
  - `TOP_FILES_COUNT`: 15 → 10
  - `README_TOKEN_BUDGET`: 500 → 400
  - `PACKAGE_JSON_TOKEN_BUDGET`: 300 → 250
  - `FILE_TREE_TOKEN_BUDGET`: 400 → 350
- Created `HEURISTICS_LIMITS` in constants.ts:
  - `MAX_FILES`: 500 (unchanged)
  - `MAX_FILE_SIZE`: 100KB → 50KB
- Updated `context.ts`: use CONTEXT_LIMITS constants
- Updated `heuristics.ts`: use HEURISTICS_LIMITS constants

### Decisions
- Centralized constants in constants.ts for configurability
- Reduced token budgets proportionally (~25% reduction)
- File size limit halved to exclude large generated files

### Verification
- TypeScript: pass
- Tests: 428 passed
- Lint: 0 errors

---

## 2026-01-10: PRD-018/019/020 - Verification of existing behavior

### Completed
- PRD-018: Verified all artifacts are generated (SKILL.md, summary.md, architecture.md/json, file-index.json, meta.json)
- PRD-019: Verified skill installation to ~/.config/opencode/skill/{name}/SKILL.md and ~/.claude/skills/{name}/SKILL.md
- PRD-020: Verified CLI progress feedback (spinner, onProgress callback, --verbose flag)

### Notes
- Updated PRD-018: field name is "analyzedAt" not "generated" in meta.json
- Updated PRD-019: path structure is {name}/SKILL.md not {name}.md
- No code changes needed - features already implemented

### Verification
- Code review confirmed implementations exist

---

## 2026-01-10: PRD-012/013 - Remote-first analysis flow

### Completed
- PRD-012: Check offworld.sh API BEFORE local cache
- PRD-013: Upload newly generated analyses to offworld.sh

### Changes
- `apps/cli/src/handlers/pull.ts`:
  - Imported `checkRemote`, `pushAnalysis`, `canPushToWeb`, `loadAuthData`
  - Reordered flow: remote check → local cache → local generation
  - Remote check uses `checkRemote()` then `pullAnalysis()` only if SHA matches
  - Added `tryUploadAnalysis()` helper after local generation
  - Upload requires auth and canPushToWeb check (5+ stars, GitHub only)
  - Upload failures are non-blocking (logged with verbose)
- Updated `apps/cli/src/__tests__/handlers.test.ts`:
  - Added `mockCheckRemote` setup
  - Updated "tries remote analysis before local generation" test
  - Split "falls back" test into two: no remote exists, remote SHA differs

### Decisions
- SHA comparison uses 7-char prefix normalization
- Remote check happens BEFORE local cache check (per PRD)
- Upload only attempts for GitHub repos with 5+ stars
- Upload is best-effort, failures logged to verbose only

### Verification
- TypeScript: SDK/CLI pass
- Tests: 23 passed (+1 new test)
- Lint: 0 errors

---

## 2026-01-10: PRD-015 - Sparse checkout for large repos

### Completed
- PRD-015: Implement sparse checkout via --sparse flag

### Changes
- `packages/sdk/src/clone.ts`:
  - Added `sparse?: boolean` to `CloneOptions`
  - Added `SPARSE_CHECKOUT_DIRS` constant: src, lib, packages, docs, README.md, package.json
  - Split cloneRepo into `cloneStandard()` and `cloneSparse()` helpers
  - Sparse uses `--filter=blob:none --no-checkout --sparse` then `sparse-checkout set`
- `apps/cli/src/index.ts`:
  - Added `--sparse` flag to pull command
- `apps/cli/src/handlers/pull.ts`:
  - Added `sparse` to PullOptions, passed to cloneRepo
- `packages/sdk/src/__tests__/clone.test.ts`:
  - Added 4 tests for sparse checkout functionality
  - Updated inline git mock to handle sparse-checkout/checkout commands
- `packages/sdk/src/__tests__/mocks/git.ts`:
  - Added sparse-checkout and checkout cases

### Decisions
- Sparse is opt-in (--sparse flag) not auto-detected
- Auto-detection of large repos deferred (requires remote API query)
- Sparse directories include README.md and package.json for metadata

### Verification
- TypeScript: SDK/CLI pass
- Tests: 447 passed (+4 new)
- Lint: 0 errors

---

## 2026-01-10: PRD-017 - Performance timing breakdown

### Completed
- PRD-017: Add timing breakdown to verbose output

### Changes
- `packages/sdk/src/analysis/pipeline.ts`:
  - Added `PipelineTiming` interface with total and per-step timings
  - Added `onTiming` callback to `AnalysisPipelineOptions`
  - Wrapped all pipeline steps with `timeStep`/`timeStepAsync` for measurement
  - Calls `onTiming` at end of pipeline
- `packages/sdk/src/analysis/index.ts`:
  - Export `PipelineTiming` type
- `apps/cli/src/handlers/pull.ts`:
  - Added `onTiming` callback in verbose mode
  - Prints total time and per-step breakdown

### Notes
- Actual <15s performance depends on AI API latency
- Local steps (rank, context, save, install) are ~1-2s total
- AI calls (analyze, skill) dominate at 5-10s+ per call
- Timing breakdown helps identify bottlenecks

### Verification
- TypeScript: SDK/CLI pass
- Tests: 447 passed
- Lint: 0 errors
