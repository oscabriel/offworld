name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  deploy-convex:
    name: Deploy Convex Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install
        run: bun install

      - name: Deploy to Convex
        run: bunx convex deploy
        working-directory: packages/backend
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

  build:
    name: Build ${{ matrix.target }}
    needs: deploy-convex
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: darwin-arm64
            os: macos-latest
            bun_target: bun-darwin-arm64
          - target: darwin-x64
            os: macos-latest
            bun_target: bun-darwin-x64
          - target: linux-arm64
            os: ubuntu-latest
            bun_target: bun-linux-arm64
          - target: linux-x64
            os: ubuntu-latest
            bun_target: bun-linux-x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install
        run: bun install

      - name: Generate Convex types
        run: bunx convex codegen
        working-directory: packages/backend
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Build packages
        run: bun run build

      - name: Test
        run: bun run test
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
          CONVEX_URL: ${{ secrets.CONVEX_URL }}

      - name: Compile CLI binary
        run: |
          bun build ./dist/cli.mjs --compile --target=${{ matrix.bun_target }} --outfile=ow
        working-directory: apps/cli

      - name: Create archive
        run: |
          tar -czvf ow-${{ matrix.target }}.tar.gz ow
        working-directory: apps/cli

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ow-${{ matrix.target }}
          path: apps/cli/ow-${{ matrix.target }}.tar.gz

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Move artifacts
        run: |
          mkdir -p release
          find artifacts -name "*.tar.gz" -exec mv {} release/ \;

      - name: Generate checksums
        run: |
          cd release
          sha256sum *.tar.gz > checksums.txt

      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          bunx changelogithub --output RELEASE_NOTES.md --no-group
          echo "Generated changelog:"
          cat RELEASE_NOTES.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.version.outputs.version }}
          body_path: RELEASE_NOTES.md
          files: |
            release/*.tar.gz
            release/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "## Release ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Assets" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | File |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| macOS (Apple Silicon) | \`ow-darwin-arm64.tar.gz\` |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS (Intel) | \`ow-darwin-x64.tar.gz\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux (ARM64) | \`ow-linux-arm64.tar.gz\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux (x64) | \`ow-linux-x64.tar.gz\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "- [npm package](https://www.npmjs.com/package/offworld)" >> $GITHUB_STEP_SUMMARY

  publish-npm:
    name: Publish to npm
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Install
        run: bun install

      - name: Generate Convex types
        run: bunx convex codegen
        working-directory: packages/backend
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Build packages
        run: bun run build

      - name: Get versions
        id: versions
        run: |
          echo "types=$(jq -r .version packages/types/package.json)" >> $GITHUB_OUTPUT
          echo "backend_api=$(jq -r .version packages/backend-api/package.json)" >> $GITHUB_OUTPUT
          echo "sdk=$(jq -r .version packages/sdk/package.json)" >> $GITHUB_OUTPUT
          echo "cli=$(jq -r .version apps/cli/package.json)" >> $GITHUB_OUTPUT

      - name: Publish @offworld/types
        id: publish_types
        run: |
          if npm view @offworld/types@${{ steps.versions.outputs.types }} > /dev/null 2>&1; then
            echo "skipped=true" >> $GITHUB_OUTPUT
            echo "@offworld/types@${{ steps.versions.outputs.types }} already published, skipping"
          else
            cd packages/types && npm publish --access public
            echo "skipped=false" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @offworld/backend-api
        id: publish_backend_api
        run: |
          if npm view @offworld/backend-api@${{ steps.versions.outputs.backend_api }} > /dev/null 2>&1; then
            echo "skipped=true" >> $GITHUB_OUTPUT
            echo "@offworld/backend-api@${{ steps.versions.outputs.backend_api }} already published, skipping"
          else
            cd packages/backend-api && npm publish --access public
            echo "skipped=false" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @offworld/sdk
        id: publish_sdk
        run: |
          if npm view @offworld/sdk@${{ steps.versions.outputs.sdk }} > /dev/null 2>&1; then
            echo "skipped=true" >> $GITHUB_OUTPUT
            echo "@offworld/sdk@${{ steps.versions.outputs.sdk }} already published, skipping"
          else
            cd packages/sdk && npm publish --access public
            echo "skipped=false" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish offworld (CLI)
        id: publish_cli
        run: |
          if npm view offworld@${{ steps.versions.outputs.cli }} > /dev/null 2>&1; then
            echo "skipped=true" >> $GITHUB_OUTPUT
            echo "offworld@${{ steps.versions.outputs.cli }} already published, skipping"
          else
            cd apps/cli && npm publish --access public
            echo "skipped=false" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          CONVEX_URL: ${{ secrets.CONVEX_URL }}

      - name: Publish Summary
        run: |
          echo "## npm Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.publish_types.outputs.skipped }}" = "true" ]; then
            echo "| @offworld/types | ${{ steps.versions.outputs.types }} | Skipped (exists) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| @offworld/types | ${{ steps.versions.outputs.types }} | Published |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.publish_backend_api.outputs.skipped }}" = "true" ]; then
            echo "| @offworld/backend-api | ${{ steps.versions.outputs.backend_api }} | Skipped (exists) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| @offworld/backend-api | ${{ steps.versions.outputs.backend_api }} | Published |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.publish_sdk.outputs.skipped }}" = "true" ]; then
            echo "| @offworld/sdk | ${{ steps.versions.outputs.sdk }} | Skipped (exists) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| @offworld/sdk | ${{ steps.versions.outputs.sdk }} | Published |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.publish_cli.outputs.skipped }}" = "true" ]; then
            echo "| offworld | ${{ steps.versions.outputs.cli }} | Skipped (exists) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| offworld | ${{ steps.versions.outputs.cli }} | Published |" >> $GITHUB_STEP_SUMMARY
          fi

  update-homebrew:
    name: Update Homebrew Tap
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Checkout tap
        uses: actions/checkout@v4
        with:
          repository: oscabriel/homebrew-tap
          token: ${{ secrets.TAP_TOKEN }}
          path: tap

      - name: Download checksums
        run: |
          curl -sL "https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/checksums.txt" -o checksums.txt

      - name: Update formula
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          DARWIN_ARM64_SHA=$(grep "darwin-arm64" checksums.txt | cut -d' ' -f1)
          DARWIN_X64_SHA=$(grep "darwin-x64" checksums.txt | cut -d' ' -f1)
          LINUX_ARM64_SHA=$(grep "linux-arm64" checksums.txt | cut -d' ' -f1)
          LINUX_X64_SHA=$(grep "linux-x64" checksums.txt | cut -d' ' -f1)

          cat > tap/Formula/ow.rb << EOF
          class Ow < Formula
            desc "Offworld CLI - Generate references for your dependencies"
            homepage "https://offworld.sh"
            version "$VERSION"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/${{ github.repository }}/releases/download/v$VERSION/ow-darwin-arm64.tar.gz"
                sha256 "$DARWIN_ARM64_SHA"
              else
                url "https://github.com/${{ github.repository }}/releases/download/v$VERSION/ow-darwin-x64.tar.gz"
                sha256 "$DARWIN_X64_SHA"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/${{ github.repository }}/releases/download/v$VERSION/ow-linux-arm64.tar.gz"
                sha256 "$LINUX_ARM64_SHA"
              else
                url "https://github.com/${{ github.repository }}/releases/download/v$VERSION/ow-linux-x64.tar.gz"
                sha256 "$LINUX_X64_SHA"
              end
            end

            def install
              bin.install "ow"
            end

            test do
              assert_match "ow", shell_output("#{bin}/ow --version")
            end
          end
          EOF

      - name: Commit and push
        run: |
          cd tap
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/ow.rb
          git commit -m "Update ow to v${{ steps.version.outputs.version }}"
          git push