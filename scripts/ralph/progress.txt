
## 2026-01-17 - US-001

- Replaced Better Auth config with WorkOS JWT validation
- Files changed: `packages/backend/convex/auth.config.ts`
- **Learnings:**
  - Two JWT issuers needed: SSO (`https://api.workos.com/`) and User Management (`https://api.workos.com/user_management/${clientId}`)
  - Both issuers share the same JWKS endpoint: `https://api.workos.com/sso/jwks/${clientId}`
  - WORKOS_CLIENT_ID must be available at module evaluation time (top-level throw if missing)

---

## 2026-01-17 - US-014

- Replaced Convex-based device auth with direct WorkOS API calls
- Files changed:
  - `apps/cli/src/handlers/auth.ts`
- **Learnings:**
  - WorkOS device auth uses two endpoints: `/user_management/authorize/device` (request code) and `/user_management/authenticate` (poll for tokens)
  - Grant type for device code: `urn:ietf:params:oauth:grant-type:device_code`
  - Response includes `verification_uri_complete` with user code already embedded - use this for one-click auth
  - Error handling: `authorization_pending` = keep polling, `slow_down` = increase interval by 5s
  - `WORKOS_CLIENT_ID` env var required - use getter function to satisfy TypeScript's control flow analysis
  - WorkOS returns user info (`user.id`, `user.email`) directly in token response - no separate user fetch needed

---


- Removed betterAuth component from convex.config.ts
- Files changed: `packages/backend/convex/convex.config.ts`
- **Learnings:**
  - defineApp() can be called empty - no components needed for basic Convex auth
  - WorkOS JWT validation handled entirely by auth.config.ts, not by components

---

## 2026-01-17 - US-003, US-004, US-005, US-006 (Atomic Batch)

- Updated schema: removed deviceCode table, added workosId to users with index
- Replaced Better Auth auth.ts with WorkOS-based getAuthUser/ensureUser helpers
- Updated http.ts push endpoint to use ctx.auth.getUserIdentity()
- Deleted deviceAuth.ts
- Files changed:
  - `packages/backend/convex/schema.ts`
  - `packages/backend/convex/auth.ts`
  - `packages/backend/convex/auth.config.ts`
  - `packages/backend/convex/http.ts`
  - `packages/backend/convex/deviceAuth.ts` (deleted)
  - `packages/backend/convex/__tests__/analyses.test.ts`
  - `packages/backend/convex/AGENTS.md`
- **Learnings:**
  - US-002 removing betterAuth component breaks auth.ts/http.ts which depend on it - must be done atomically with US-003-006
  - auth.config.ts should use placeholder clientId for dev to avoid blocking codegen: `process.env.WORKOS_CLIENT_ID ?? "client_placeholder"`
  - `identity.subject` from WorkOS JWT is the user ID (workosId)
  - Test fixtures need updating when schema adds required fields (workosId)
  - convex codegen env var error is deployment-level, not schema error - schema is valid if local typecheck passes

---

## 2026-01-17 - US-007, US-016 (Dependency Batch)

- Created `apps/web/src/start.ts` with authkitMiddleware for TanStack Start
- Added `@workos/authkit-tanstack-react-start` dependency
- Updated `apps/web/AGENTS.md` with WorkOS auth patterns
- Files changed:
  - `apps/web/src/start.ts` (new)
  - `apps/web/package.json`
  - `apps/web/AGENTS.md`
  - `bun.lock`
- **Learnings:**
  - Package name is `@workos/authkit-tanstack-react-start` (note the `-react-` in name)
  - US-016 (dependency) must be completed with US-007 since start.ts imports from the package
  - PRD priority ordering doesn't account for dependency chains - higher priority stories may depend on lower priority ones
  - `createStart()` exports `startInstance` which TanStack Start uses for SSR middleware

---

## 2026-01-17 - US-008

- Created callback.tsx OAuth handler route for WorkOS
- Files changed:
  - `apps/web/src/routes/callback.tsx` (new)
  - `apps/web/src/routeTree.gen.ts` (auto-regenerated)
- **Learnings:**
  - `handleCallbackRoute()` returns a handler function, so use `GET: handleCallbackRoute()` not `GET: handleCallbackRoute`
  - Route must use `server.handlers` pattern for server-side route handling
  - TanStack Router auto-regenerates routeTree.gen.ts on build when new route files added
  - Import from `@workos/authkit-tanstack-react-start` (same package as middleware)

---

## 2026-01-17 - US-009

- Updated __root.tsx to use WorkOS auth instead of Better Auth
- Files changed:
  - `apps/web/src/routes/__root.tsx`
  - `apps/web/AGENTS.md`
- **Learnings:**
  - `getAuth()` returns `UserInfo | NoUserInfo` - must check `auth.user` before accessing `accessToken`
  - Use `createServerFn` wrapper for SSR-compatible auth fetching
  - Removed ConvexBetterAuthProvider from RootDocument - Convex provider wrapping moves to router.tsx in US-010
  - PRD acceptance criteria says `@workos/authkit-tanstack-start` but correct package is `@workos/authkit-tanstack-react-start`

---

## 2026-01-17 - US-010

- Added AuthKitProvider and ConvexProviderWithAuth to router.tsx
- Created useAuthFromWorkOS hook to bridge WorkOS AuthKit to Convex auth interface
- Files changed:
  - `apps/web/src/router.tsx`
  - `apps/web/AGENTS.md`
- **Learnings:**
  - ConvexProviderWithAuth expects `useAuth` hook returning `{ isLoading, isAuthenticated, fetchAccessToken }`
  - `fetchAccessToken` must return `Promise<string | null>` (not undefined) - use `?? null` conversion
  - TanStack Router's `Wrap` option in `createTanStackRouter` is the right place for auth providers
  - WorkOS `useAuth` returns `{ user, loading }`, `useAccessToken` returns `{ getAccessToken, loading }`
  - Reference implementation at github.com/workos/template-convex-tanstack-react-start-authkit

---

## 2026-01-17 - US-011

- Updated sign-in.tsx to use WorkOS getSignInUrl instead of Better Auth authClient
- Files changed:
  - `apps/web/src/routes/sign-in.tsx`
  - `apps/web/AGENTS.md`
- **Learnings:**
  - `getSignInUrl()` is server-side only - use in loader, not component
  - Use `loaderDeps` to pass search params to loader for redirect handling
  - Button with anchor tag pattern: `<a href={signInUrl}><Button>` for navigation
  - Removed GitHub-specific icon since WorkOS handles provider selection on their hosted page

---

## 2026-01-17 - US-012

- Updated profile.tsx to use WorkOS useAuth instead of Better Auth authClient
- Files changed:
  - `apps/web/src/routes/profile.tsx`
  - `apps/web/AGENTS.md`
- **Learnings:**
  - `useAuth()` from `@workos/authkit-tanstack-react-start/client` provides `signOut()` method
  - WorkOS signOut is simpler than Better Auth - no fetchOptions callback needed
  - Use `window.location.href = "/"` after `signOut()` for redirect (not in callback)

---

## 2026-01-17 - US-013

- Deleted legacy Better Auth files from web app
- Files deleted:
  - `apps/web/src/lib/auth-client.ts`
  - `apps/web/src/lib/auth-server.ts`
  - `apps/web/src/routes/device.$code.tsx`
  - `apps/web/src/routes/login.tsx`
  - `apps/web/src/routes/api/auth/$.ts` (also deleted - was Better Auth API handler)
- Files changed:
  - `apps/web/src/routeTree.gen.ts` (regenerated)
  - `apps/web/AGENTS.md`
- **Learnings:**
  - `api/auth/$.ts` was the Better Auth API handler (not in PRD criteria but must be deleted)
  - `routeTree.gen.ts` is NOT regenerated by tsc/typecheck - must delete the file and run `bun run dev`
  - Route tree plugin only runs during Vite dev/build, not during type checking

---

## 2026-01-17 - US-015

- Updated T3 env validation to use WorkOS env vars instead of Better Auth
- Files changed:
  - `packages/env/src/server.ts`
- **Learnings:**
  - PRD mentioned GITHUB_CLIENT_ID/SECRET but actual file had BETTER_AUTH_SECRET/URL - same outcome (remove old auth vars)
  - T3 env uses `z.string().url()` not `z.url()` - corrected in edit

---

## 2026-01-17 - US-017

- Removed Better Auth packages from web and backend
- Files changed:
  - `apps/web/package.json` (removed @convex-dev/better-auth, better-auth)
  - `packages/backend/package.json` (removed @convex-dev/better-auth, better-auth)
  - `bun.lock` (updated)
- **Learnings:**
  - Packages used `catalog:` version specifier from workspace catalog (bun workspace feature)
  - No code changes needed - Better Auth imports already removed in prior stories
  - Lockfile updated automatically, removing 98 lines of Better Auth dependencies

---
