#!/bin/bash
# Offworld CLI Installer
# Usage: curl -fsSL https://offworld.sh/install | bash
#
# This script detects your OS and architecture, downloads the correct binary,
# verifies the checksum, and installs it to ~/.local/bin/ow

set -e

# Configuration
GITHUB_REPO="oscabriel/offworld"
INSTALL_DIR="${INSTALL_DIR:-$HOME/.local/bin}"
BINARY_NAME="ow"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

success() {
    echo -e "${GREEN}[OK]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
    exit 1
}

# Detect OS
detect_os() {
    local os
    os="$(uname -s)"
    case "$os" in
        Darwin)
            echo "darwin"
            ;;
        Linux)
            echo "linux"
            ;;
        *)
            error "Unsupported operating system: $os"
            ;;
    esac
}

# Detect architecture
detect_arch() {
    local arch
    arch="$(uname -m)"
    case "$arch" in
        x86_64|amd64)
            echo "x64"
            ;;
        arm64|aarch64)
            echo "arm64"
            ;;
        *)
            error "Unsupported architecture: $arch"
            ;;
    esac
}

# Get latest release version
get_latest_version() {
    local latest
    latest=$(curl -sL "https://api.github.com/repos/$GITHUB_REPO/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
    if [ -z "$latest" ]; then
        error "Failed to get latest version. Check your internet connection."
    fi
    echo "$latest"
}

# Download and verify binary
download_and_install() {
    local os="$1"
    local arch="$2"
    local version="$3"
    local target="${os}-${arch}"
    local download_url="https://github.com/$GITHUB_REPO/releases/download/${version}/ow-${target}.tar.gz"
    local checksums_url="https://github.com/$GITHUB_REPO/releases/download/${version}/checksums.txt"

    info "Downloading offworld CLI ${version} for ${target}..."

    # Create temp directory
    local tmp_dir
    tmp_dir=$(mktemp -d)
    trap "rm -rf $tmp_dir" EXIT

    # Download binary
    curl -sL "$download_url" -o "$tmp_dir/ow.tar.gz" || error "Failed to download binary"

    # Download checksums
    curl -sL "$checksums_url" -o "$tmp_dir/checksums.txt" || error "Failed to download checksums"

    # Verify checksum
    info "Verifying checksum..."
    local expected_checksum
    expected_checksum=$(grep "ow-${target}.tar.gz" "$tmp_dir/checksums.txt" | cut -d' ' -f1)

    if [ -z "$expected_checksum" ]; then
        error "Could not find checksum for ${target}"
    fi

    local actual_checksum
    if command -v sha256sum &> /dev/null; then
        actual_checksum=$(sha256sum "$tmp_dir/ow.tar.gz" | cut -d' ' -f1)
    elif command -v shasum &> /dev/null; then
        actual_checksum=$(shasum -a 256 "$tmp_dir/ow.tar.gz" | cut -d' ' -f1)
    else
        warn "Could not verify checksum (sha256sum/shasum not found)"
        actual_checksum="$expected_checksum"  # Skip verification
    fi

    if [ "$expected_checksum" != "$actual_checksum" ]; then
        error "Checksum verification failed!\nExpected: $expected_checksum\nActual: $actual_checksum"
    fi
    success "Checksum verified"

    # Extract binary
    info "Extracting binary..."
    tar -xzf "$tmp_dir/ow.tar.gz" -C "$tmp_dir" || error "Failed to extract archive"

    # Create install directory if it doesn't exist
    mkdir -p "$INSTALL_DIR" || error "Failed to create install directory: $INSTALL_DIR"

    # Install binary
    info "Installing to $INSTALL_DIR/$BINARY_NAME..."
    mv "$tmp_dir/ow" "$INSTALL_DIR/$BINARY_NAME" || error "Failed to move binary"
    chmod +x "$INSTALL_DIR/$BINARY_NAME" || error "Failed to make binary executable"

    success "Installed $BINARY_NAME to $INSTALL_DIR"
}

# Check if directory is in PATH
check_path() {
    local dir="$1"
    case ":$PATH:" in
        *":$dir:"*)
            return 0
            ;;
        *)
            return 1
            ;;
    esac
}

# Main installation
main() {
    echo ""
    echo "   ____  __  __                     __    __"
    echo "  / __ \/ /_/ /  __  ______  _____/ /___/ /"
    echo " / / / / __/ / |/ / / / / / __ / __/ / __/"
    echo "/ /_/ / /_/   </ /_/ /_/ / /_/ / /_/ / /_/ "
    echo "\____/\__/_/|_\__, /\__,_/\____/\__/_/\__/ "
    echo "             /____/                        "
    echo ""
    echo "Offworld CLI Installer"
    echo ""

    # Detect platform
    local os arch
    os=$(detect_os)
    arch=$(detect_arch)
    info "Detected platform: ${os}-${arch}"

    # Get latest version
    local version
    version=$(get_latest_version)
    info "Latest version: ${version}"

    # Download and install
    download_and_install "$os" "$arch" "$version"

    # Check PATH
    echo ""
    if ! check_path "$INSTALL_DIR"; then
        warn "$INSTALL_DIR is not in your PATH"
        echo ""
        echo "Add this to your shell profile (~/.bashrc, ~/.zshrc, etc.):"
        echo ""
        echo "    export PATH=\"\$HOME/.local/bin:\$PATH\""
        echo ""
        echo "Then restart your shell or run:"
        echo ""
        echo "    source ~/.bashrc  # or ~/.zshrc"
        echo ""
    fi

    # Success message
    echo ""
    success "Installation complete!"
    echo ""
    echo "Get started with:"
    echo ""
    echo "    ow --help           # Show help"
    echo "    ow pull owner/repo  # Clone and analyze a repo"
    echo ""
    echo "Documentation: https://offworld.sh/docs"
    echo ""
}

# Run main
main "$@"
