name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  deploy-convex:
    name: Deploy Convex Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Deploy to Convex
        run: bunx convex deploy
        working-directory: packages/backend
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

  build:
    name: Build ${{ matrix.target }}
    needs: deploy-convex
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: darwin-arm64
            os: macos-latest
            bun_target: bun-darwin-arm64
          - target: darwin-x64
            os: macos-latest
            bun_target: bun-darwin-x64
          - target: linux-arm64
            os: ubuntu-latest
            bun_target: bun-linux-arm64
          - target: linux-x64
            os: ubuntu-latest
            bun_target: bun-linux-x64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Generate Convex types
        run: bunx convex codegen
        working-directory: packages/backend
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Build Types
        run: bun run build
        working-directory: packages/types

      - name: Build Backend API
        run: bun run build
        working-directory: packages/backend-api

      - name: Build SDK
        run: bun run build
        working-directory: packages/sdk
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}

      - name: Build CLI
        run: bun run build
        working-directory: apps/cli
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}
          WORKOS_CLIENT_ID: ${{ secrets.WORKOS_CLIENT_ID }}

      - name: Compile to standalone binary
        run: |
          bun build ./dist/cli.mjs --compile --target=${{ matrix.bun_target }} --outfile=ow
        working-directory: apps/cli

      - name: Create archive
        run: |
          tar -czvf ow-${{ matrix.target }}.tar.gz ow
        working-directory: apps/cli

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ow-${{ matrix.target }}
          path: apps/cli/ow-${{ matrix.target }}.tar.gz

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Move artifacts to release directory
        run: |
          mkdir -p release
          find artifacts -name "*.tar.gz" -exec mv {} release/ \;

      - name: Generate checksums
        run: |
          cd release
          sha256sum *.tar.gz > checksums.txt

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## Installation

            ### Quick Install (recommended)
            ```bash
            curl -fsSL https://offworld.sh/install | bash
            ```

            ### Homebrew
            ```bash
            brew install oscabriel/tap/ow
            ```

            ### npm
            ```bash
            npm install -g offworld
            ```

            ### Manual Download
            Download the appropriate binary for your platform below.

            ## Checksums
            See `checksums.txt` for SHA-256 checksums of all binaries.
          files: |
            release/*.tar.gz
            release/checksums.txt
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-npm:
    name: Publish to npm
    needs: [deploy-convex, release]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: bun install

      - name: Generate Convex types
        run: bunx convex codegen
        working-directory: packages/backend
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Build Types
        run: bun run build
        working-directory: packages/types

      - name: Build Backend API
        run: bun run build
        working-directory: packages/backend-api

      - name: Build SDK
        run: bun run build
        working-directory: packages/sdk
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}

      - name: Build CLI
        run: bun run build
        working-directory: apps/cli
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}
          WORKOS_CLIENT_ID: ${{ secrets.WORKOS_CLIENT_ID }}

      - name: Publish Types to npm
        run: npm publish --access public
        working-directory: packages/types
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish Backend API to npm
        run: npm publish --access public
        working-directory: packages/backend-api
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish SDK to npm
        run: npm publish --access public
        working-directory: packages/sdk
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish CLI to npm
        run: npm publish --access public
        working-directory: apps/cli
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  update-homebrew:
    name: Update Homebrew Tap
    needs: release
    runs-on: macos-latest

    steps:
      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Checkout Homebrew tap
        uses: actions/checkout@v4
        with:
          repository: oscabriel/homebrew-tap
          token: ${{ secrets.TAP_TOKEN }}
          path: tap

      - name: Download checksums
        run: |
          curl -sL "https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/checksums.txt" -o checksums.txt

      - name: Update formula
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          OWNER="${GITHUB_REPOSITORY_OWNER}"

          # Extract checksums
          DARWIN_ARM64_SHA=$(grep "darwin-arm64" checksums.txt | cut -d' ' -f1)
          DARWIN_X64_SHA=$(grep "darwin-x64" checksums.txt | cut -d' ' -f1)
          LINUX_ARM64_SHA=$(grep "linux-arm64" checksums.txt | cut -d' ' -f1)
          LINUX_X64_SHA=$(grep "linux-x64" checksums.txt | cut -d' ' -f1)

          cat > tap/Formula/ow.rb << FORMULA_EOF
          class Ow < Formula
            desc "Offworld CLI - Generate references for your dependencies"
            homepage "https://offworld.sh"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/${OWNER}/releases/download/v${VERSION}/ow-darwin-arm64.tar.gz"
                sha256 "${DARWIN_ARM64_SHA}"
              else
                url "https://github.com/${OWNER}/releases/download/v${VERSION}/ow-darwin-x64.tar.gz"
                sha256 "${DARWIN_X64_SHA}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/${OWNER}/releases/download/v${VERSION}/ow-linux-arm64.tar.gz"
                sha256 "${LINUX_ARM64_SHA}"
              else
                url "https://github.com/${OWNER}/releases/download/v${VERSION}/ow-linux-x64.tar.gz"
                sha256 "${LINUX_X64_SHA}"
              end
            end

            def install
              bin.install "ow"
            end

            test do
              assert_match "ow", shell_output("#{bin}/ow --version")
            end
          end
          FORMULA_EOF

      - name: Audit formula
        run: |
          brew audit --strict --online tap/Formula/ow.rb

      - name: Style check formula
        run: |
          brew style tap/Formula/ow.rb

      - name: Commit and push formula update
        run: |
          cd tap
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/ow.rb
          git commit -m "Update ow to v${{ steps.version.outputs.version }}"
          git push
