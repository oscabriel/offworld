
## 2026-01-17 - US-001

- Replaced Better Auth config with WorkOS JWT validation
- Files changed: `packages/backend/convex/auth.config.ts`
- **Learnings:**
  - Two JWT issuers needed: SSO (`https://api.workos.com/`) and User Management (`https://api.workos.com/user_management/${clientId}`)
  - Both issuers share the same JWKS endpoint: `https://api.workos.com/sso/jwks/${clientId}`
  - WORKOS_CLIENT_ID must be available at module evaluation time (top-level throw if missing)

---

## 2026-01-17 - US-002

- Removed betterAuth component from convex.config.ts
- Files changed: `packages/backend/convex/convex.config.ts`
- **Learnings:**
  - defineApp() can be called empty - no components needed for basic Convex auth
  - WorkOS JWT validation handled entirely by auth.config.ts, not by components

---

## 2026-01-17 - US-003, US-004, US-005, US-006 (Atomic Batch)

- Updated schema: removed deviceCode table, added workosId to users with index
- Replaced Better Auth auth.ts with WorkOS-based getAuthUser/ensureUser helpers
- Updated http.ts push endpoint to use ctx.auth.getUserIdentity()
- Deleted deviceAuth.ts
- Files changed:
  - `packages/backend/convex/schema.ts`
  - `packages/backend/convex/auth.ts`
  - `packages/backend/convex/auth.config.ts`
  - `packages/backend/convex/http.ts`
  - `packages/backend/convex/deviceAuth.ts` (deleted)
  - `packages/backend/convex/__tests__/analyses.test.ts`
  - `packages/backend/convex/AGENTS.md`
- **Learnings:**
  - US-002 removing betterAuth component breaks auth.ts/http.ts which depend on it - must be done atomically with US-003-006
  - auth.config.ts should use placeholder clientId for dev to avoid blocking codegen: `process.env.WORKOS_CLIENT_ID ?? "client_placeholder"`
  - `identity.subject` from WorkOS JWT is the user ID (workosId)
  - Test fixtures need updating when schema adds required fields (workosId)
  - convex codegen env var error is deployment-level, not schema error - schema is valid if local typecheck passes

---

## 2026-01-17 - US-007, US-016 (Dependency Batch)

- Created `apps/web/src/start.ts` with authkitMiddleware for TanStack Start
- Added `@workos/authkit-tanstack-react-start` dependency
- Updated `apps/web/AGENTS.md` with WorkOS auth patterns
- Files changed:
  - `apps/web/src/start.ts` (new)
  - `apps/web/package.json`
  - `apps/web/AGENTS.md`
  - `bun.lock`
- **Learnings:**
  - Package name is `@workos/authkit-tanstack-react-start` (note the `-react-` in name)
  - US-016 (dependency) must be completed with US-007 since start.ts imports from the package
  - PRD priority ordering doesn't account for dependency chains - higher priority stories may depend on lower priority ones
  - `createStart()` exports `startInstance` which TanStack Start uses for SSR middleware

---

## 2026-01-17 - US-008

- Created callback.tsx OAuth handler route for WorkOS
- Files changed:
  - `apps/web/src/routes/callback.tsx` (new)
  - `apps/web/src/routeTree.gen.ts` (auto-regenerated)
- **Learnings:**
  - `handleCallbackRoute()` returns a handler function, so use `GET: handleCallbackRoute()` not `GET: handleCallbackRoute`
  - Route must use `server.handlers` pattern for server-side route handling
  - TanStack Router auto-regenerates routeTree.gen.ts on build when new route files added
  - Import from `@workos/authkit-tanstack-react-start` (same package as middleware)

---

## 2026-01-17 - US-009

- Updated __root.tsx to use WorkOS auth instead of Better Auth
- Files changed:
  - `apps/web/src/routes/__root.tsx`
  - `apps/web/AGENTS.md`
- **Learnings:**
  - `getAuth()` returns `UserInfo | NoUserInfo` - must check `auth.user` before accessing `accessToken`
  - Use `createServerFn` wrapper for SSR-compatible auth fetching
  - Removed ConvexBetterAuthProvider from RootDocument - Convex provider wrapping moves to router.tsx in US-010
  - PRD acceptance criteria says `@workos/authkit-tanstack-start` but correct package is `@workos/authkit-tanstack-react-start`

---
