{
  "branchName": "ralph/workos-authkit-migration",
  "userStories": [
    {
      "id": "US-001",
      "title": "Backend: Replace Better Auth config with WorkOS JWT validation",
      "acceptanceCriteria": [
        "auth.config.ts uses customJwt provider with WorkOS JWKS endpoint",
        "Two JWT issuers configured (SSO and User Management)",
        "WORKOS_CLIENT_ID env var required at runtime",
        "typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Phase 1.1 - Foundation for all other auth changes"
    },
    {
      "id": "US-002",
      "title": "Backend: Remove betterAuth component from convex.config.ts",
      "acceptanceCriteria": [
        "convex.config.ts has no betterAuth component import",
        "defineApp() called with no components",
        "typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Phase 1.2"
    },
    {
      "id": "US-003",
      "title": "Backend: Update schema - remove deviceCode, add workosId to users",
      "acceptanceCriteria": [
        "deviceCode table removed from schema.ts",
        "users table has workosId: v.string() field",
        "users table has by_workosId index",
        "npx convex dev succeeds without schema errors",
        "typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Phase 1.3 - Breaking change: existing deviceCode data lost"
    },
    {
      "id": "US-004",
      "title": "Backend: Create new auth.ts helper with getAuthUser and ensureUser",
      "acceptanceCriteria": [
        "getAuthUser() extracts workosId from ctx.auth.getUserIdentity()",
        "getAuthUser() queries users table by workosId index",
        "ensureUser mutation creates user record if not exists",
        "getCurrentUser query exported",
        "getCurrentUserSafe query exported",
        "typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Phase 1.4 - Replaces old Better Auth helper. Completed with US-003 as dependency."
    },
    {
      "id": "US-005",
      "title": "Backend: Update http.ts push endpoint to use WorkOS JWT validation",
      "acceptanceCriteria": [
        "No import from old auth module",
        "Uses ctx.auth.getUserIdentity() for validation",
        "Returns 401 if identity is null",
        "Uses identity.subject as userId",
        "typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Phase 1.5 - Completed with US-003 as dependency."
    },
    {
      "id": "US-006",
      "title": "Backend: Delete deviceAuth.ts file",
      "acceptanceCriteria": [
        "packages/backend/convex/deviceAuth.ts does not exist",
        "No imports reference deviceAuth",
        "typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Phase 1.6 - Completed with US-003 as dependency."
    },
    {
      "id": "US-007",
      "title": "Web: Create start.ts with authkitMiddleware",
      "acceptanceCriteria": [
        "apps/web/src/start.ts exists",
        "Exports startInstance from createStart()",
        "authkitMiddleware() in requestMiddleware array",
        "typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Phase 2.1"
    },
    {
      "id": "US-008",
      "title": "Web: Create callback.tsx OAuth handler route",
      "acceptanceCriteria": [
        "apps/web/src/routes/callback.tsx exists",
        "Uses createFileRoute('/callback')",
        "server.handlers.GET = handleCallbackRoute",
        "typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Phase 2.2"
    },
    {
      "id": "US-009",
      "title": "Web: Update __root.tsx to use WorkOS auth",
      "acceptanceCriteria": [
        "No ConvexBetterAuthProvider import",
        "No authClient import",
        "Uses getAuth from @workos/authkit-tanstack-start",
        "fetchWorkosAuth server function returns userId and token",
        "beforeLoad uses fetchWorkosAuth",
        "typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Phase 2.3"
    },
    {
      "id": "US-010",
      "title": "Web: Update router.tsx with AuthKitProvider and useAuthFromWorkOS",
      "acceptanceCriteria": [
        "Imports AuthKitProvider, useAccessToken, useAuth from @workos/authkit-tanstack-start/client",
        "Imports ConvexProviderWithAuth from convex/react",
        "Wrap function wraps children in AuthKitProvider > ConvexProviderWithAuth",
        "useAuthFromWorkOS hook defined with isLoading, isAuthenticated, fetchAccessToken",
        "typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Phase 2.4"
    },
    {
      "id": "US-011",
      "title": "Web: Update sign-in.tsx to use WorkOS getSignInUrl",
      "acceptanceCriteria": [
        "No authClient import",
        "Imports getSignInUrl from @workos/authkit-tanstack-start",
        "loader returns signInUrl",
        "Sign in button is anchor tag with href={signInUrl}",
        "typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Phase 2.5"
    },
    {
      "id": "US-012",
      "title": "Web: Update profile.tsx to use WorkOS useAuth",
      "acceptanceCriteria": [
        "No authClient import",
        "Imports useAuth from @workos/authkit-tanstack-start/client",
        "Uses signOut() from useAuth hook",
        "typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Phase 2.6"
    },
    {
      "id": "US-013",
      "title": "Web: Delete legacy auth files",
      "acceptanceCriteria": [
        "apps/web/src/lib/auth-client.ts does not exist",
        "apps/web/src/lib/auth-server.ts does not exist",
        "apps/web/src/routes/device.$code.tsx does not exist",
        "apps/web/src/routes/login.tsx does not exist",
        "No imports reference deleted files",
        "typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Phase 2.7"
    },
    {
      "id": "US-014",
      "title": "CLI: Update auth.ts to use direct WorkOS device auth API",
      "acceptanceCriteria": [
        "No Convex imports for auth",
        "Calls WorkOS /user_management/authorize/device endpoint",
        "Polls /user_management/authenticate with device_code grant",
        "Handles authorization_pending, slow_down, access_denied, expired_token errors",
        "Saves access_token, refresh_token, email, userId via saveAuthData",
        "typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Phase 3.1"
    },
    {
      "id": "US-015",
      "title": "Env: Update server.ts with WorkOS env vars",
      "acceptanceCriteria": [
        "GITHUB_CLIENT_ID removed",
        "GITHUB_CLIENT_SECRET removed",
        "WORKOS_CLIENT_ID: z.string() added",
        "WORKOS_API_KEY: z.string() added",
        "WORKOS_COOKIE_PASSWORD: z.string().min(32) added",
        "WORKOS_REDIRECT_URI: z.string().url() added",
        "typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": "Phase 4.3"
    },
    {
      "id": "US-016",
      "title": "Dependencies: Add @workos/authkit-tanstack-start to web app",
      "acceptanceCriteria": [
        "apps/web/package.json has @workos/authkit-tanstack-start dependency",
        "bun install succeeds"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Phase 5.1"
    },
    {
      "id": "US-017",
      "title": "Dependencies: Remove Better Auth packages from web and backend",
      "acceptanceCriteria": [
        "apps/web/package.json has no @convex-dev/better-auth",
        "apps/web/package.json has no better-auth",
        "packages/backend/package.json has no @convex-dev/better-auth",
        "packages/backend/package.json has no better-auth",
        "bun install succeeds"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Phase 5.2 + 5.3"
    },
    {
      "id": "US-018",
      "title": "Integration: Web sign-in flow works end-to-end",
      "acceptanceCriteria": [
        "Navigate to /sign-in shows sign in button",
        "Clicking button redirects to WorkOS hosted auth",
        "After auth, redirects back to /callback",
        "Callback redirects to home page as authenticated user",
        "Protected routes accessible"
      ],
      "priority": 6,
      "passes": false,
      "notes": "Verification checklist item"
    },
    {
      "id": "US-019",
      "title": "Integration: Web sign-out clears session",
      "acceptanceCriteria": [
        "Sign out button on profile page calls signOut()",
        "After sign out, user redirected to home",
        "Protected routes redirect to sign-in"
      ],
      "priority": 6,
      "passes": false,
      "notes": "Verification checklist item"
    },
    {
      "id": "US-020",
      "title": "Integration: CLI device auth flow works end-to-end",
      "acceptanceCriteria": [
        "ow auth login displays verification URL and user code",
        "Browser opens to WorkOS verification page",
        "After approval, CLI receives tokens",
        "ow auth status shows logged-in state",
        "ow push authenticates successfully"
      ],
      "priority": 6,
      "passes": false,
      "notes": "Verification checklist item"
    },
    {
      "id": "US-021",
      "title": "Integration: Convex validates WorkOS JWTs via JWKS",
      "acceptanceCriteria": [
        "ctx.auth.getUserIdentity() returns identity for valid WorkOS token",
        "Returns null for invalid/expired tokens",
        "identity.subject matches WorkOS user ID"
      ],
      "priority": 6,
      "passes": false,
      "notes": "Verification checklist item"
    }
  ]
}
