{
  "branchName": "ralph/workos-auth-migration",
  "userStories": [
    {
      "id": "US-001",
      "title": "Remove Better Auth component from Convex config",
      "acceptanceCriteria": [
        "convex.config.ts has no Better Auth import",
        "convex.config.ts has no app.use(betterAuth) call",
        "typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Phase 1.1 - First backend change"
    },
    {
      "id": "US-002",
      "title": "Configure WorkOS JWT validation in Convex",
      "acceptanceCriteria": [
        "auth.config.ts exports customJwt provider config",
        "WORKOS_CLIENT_ID env var read from process.env",
        "JWKS URL points to WorkOS endpoint",
        "Two issuers configured (api.workos.com and user_management)",
        "typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Phase 1.2"
    },
    {
      "id": "US-003",
      "title": "Rewrite auth.ts with Convex identity-based auth",
      "acceptanceCriteria": [
        "getCurrentUser query returns user by tokenIdentifier",
        "getCurrentUserSafe query never throws",
        "getUser helper throws on unauthenticated",
        "safeGetUser helper returns null on error",
        "ensureUser mutation upserts user on first login",
        "requireAdmin helper validates admin emails",
        "isAdmin query checks admin status",
        "getUserByToken internalQuery exists for HTTP handlers",
        "No Better Auth imports remain",
        "typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Phase 1.3"
    },
    {
      "id": "US-004",
      "title": "Update users table schema for WorkOS",
      "acceptanceCriteria": [
        "users table has tokenIdentifier field (string)",
        "users table has email field (string)",
        "users table has optional name field",
        "users table has optional image field",
        "users table has createdAt field (string)",
        "by_tokenIdentifier index exists",
        "by_email index exists",
        "deviceCode table removed from schema",
        "typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Phase 1.4"
    },
    {
      "id": "US-005",
      "title": "Remove Better Auth routes from http.ts",
      "acceptanceCriteria": [
        "No authComponent.registerRoutes call",
        "Push endpoint uses ctx.auth.getUserIdentity()",
        "Push endpoint calls internal.auth.getUserByToken",
        "typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Phase 1.5"
    },
    {
      "id": "US-006",
      "title": "Remove Better Auth deps from backend package.json",
      "acceptanceCriteria": [
        "@convex-dev/better-auth not in dependencies",
        "better-auth not in dependencies",
        "bun install succeeds"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Phase 1.6"
    },
    {
      "id": "US-007",
      "title": "Delete deviceAuth.ts",
      "acceptanceCriteria": [
        "packages/backend/convex/deviceAuth.ts does not exist",
        "No imports of deviceAuth in other files",
        "typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Phase 1.7"
    },
    {
      "id": "US-008",
      "title": "Add WorkOS deps to web package.json",
      "acceptanceCriteria": [
        "@workos/authkit-tanstack-react-start in dependencies",
        "@convex-dev/better-auth removed",
        "better-auth removed",
        "bun install succeeds"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Phase 2.1"
    },
    {
      "id": "US-009",
      "title": "Create start.ts middleware config",
      "acceptanceCriteria": [
        "apps/web/src/start.ts exists",
        "Exports startInstance with authkitMiddleware",
        "typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Phase 2.2"
    },
    {
      "id": "US-010",
      "title": "Create callback route for WorkOS OAuth",
      "acceptanceCriteria": [
        "apps/web/src/routes/callback.tsx exists",
        "Route handles GET via handleCallbackRoute",
        "typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Phase 2.3"
    },
    {
      "id": "US-011",
      "title": "Rewrite router.tsx with WorkOS provider",
      "acceptanceCriteria": [
        "AuthKitProvider wraps app",
        "ConvexProviderWithAuth uses useAuthFromWorkOS bridge",
        "useAuthFromWorkOS returns isLoading, isAuthenticated, fetchAccessToken",
        "No Better Auth imports",
        "typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Phase 2.4"
    },
    {
      "id": "US-012",
      "title": "Rewrite __root.tsx with WorkOS SSR auth",
      "acceptanceCriteria": [
        "fetchWorkosAuth server function calls getAuth()",
        "beforeLoad sets auth token via serverHttpClient.setAuth",
        "Prefetches getCurrentUserSafe query",
        "Returns isAuthenticated, token, userId context",
        "No Better Auth imports",
        "typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Phase 2.5"
    },
    {
      "id": "US-013",
      "title": "Rewrite sign-in.tsx with WorkOS URLs",
      "acceptanceCriteria": [
        "Loader calls getAuth() and getSignInUrl()",
        "Redirects if already authenticated",
        "Sign-in button links to WorkOS signInUrl",
        "GitHub icon displayed",
        "No Better Auth imports",
        "typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Phase 2.6"
    },
    {
      "id": "US-014",
      "title": "Rewrite profile.tsx with WorkOS sign-out",
      "acceptanceCriteria": [
        "Loader uses getAuth() for protection",
        "useAuth hook provides signOut function",
        "Sign out button calls signOut()",
        "No Better Auth imports",
        "typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Phase 2.7"
    },
    {
      "id": "US-015",
      "title": "Delete Better Auth web files",
      "acceptanceCriteria": [
        "apps/web/src/lib/auth-client.ts deleted",
        "apps/web/src/lib/auth-server.ts deleted",
        "apps/web/src/routes/device.$code.tsx deleted",
        "apps/web/src/routes/api/auth/$.ts deleted",
        "apps/web/src/routes/login.tsx deleted",
        "No broken imports in remaining files",
        "typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Phase 2.8"
    },
    {
      "id": "US-016",
      "title": "Rewrite CLI auth handler with WorkOS Device Auth",
      "acceptanceCriteria": [
        "requestDeviceCode() calls WorkOS device authorize endpoint",
        "pollForToken() calls WorkOS authenticate endpoint",
        "authLoginHandler displays user_code and verification_uri",
        "Opens browser automatically",
        "Polls with interval from response",
        "Handles authorization_pending, slow_down, access_denied, expired_token",
        "Saves token via saveAuthData on success",
        "No Convex or Better Auth imports",
        "typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Phase 3.1"
    },
    {
      "id": "US-017",
      "title": "Add ensureUser call on first login",
      "acceptanceCriteria": [
        "__root.tsx beforeLoad calls ensureUser mutation when token present",
        "staleTime: Infinity prevents repeat calls",
        "typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": "Phase 4 - First login flow"
    },
    {
      "id": "US-018",
      "title": "Set WorkOS environment variables",
      "acceptanceCriteria": [
        "WORKOS_CLIENT_ID set in Convex dashboard",
        "ADMIN_EMAILS set in Convex dashboard",
        "WORKOS_CLIENT_ID in .env.local",
        "WORKOS_API_KEY in .env.local",
        "WORKOS_COOKIE_PASSWORD in .env.local (32+ chars)",
        "WORKOS_REDIRECT_URI in .env.local"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Prerequisites"
    },
    {
      "id": "US-019",
      "title": "Web sign-in flow works end-to-end",
      "acceptanceCriteria": [
        "Sign in via GitHub redirects to WorkOS",
        "Callback route handles OAuth response",
        "User created in Convex on first login",
        "Profile page shows user info",
        "Sign out works",
        "Protected routes redirect to sign-in"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Testing - Web"
    },
    {
      "id": "US-020",
      "title": "CLI device auth flow works end-to-end",
      "acceptanceCriteria": [
        "ow auth login displays device code and URL",
        "Browser opens automatically",
        "Approving in browser completes CLI login",
        "Token saved to auth file",
        "ow auth status shows logged-in state",
        "ow auth logout clears token",
        "ow push works with new token"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Testing - CLI"
    },
    {
      "id": "US-021",
      "title": "Identity linking works",
      "acceptanceCriteria": [
        "Same GitHub account via web and CLI = same Convex user",
        "Different email = different Convex user"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Testing - Identity"
    }
  ]
}
